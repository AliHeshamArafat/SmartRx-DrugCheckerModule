@page "/dashboard/history"
@layout DashboardLayout
@inject NavigationManager Navigation
@inject HttpClient? Http

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<div class="history-page">
    <!-- Header Section -->
    <div class="history-header-container">
        <div class="history-header">
            <div class="history-header-left">
                <a href="/dashboard/drug-checker" class="back-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Back to Form
                </a>
                <h1 class="history-title">Check History</h1>
            </div>
            <div class="history-summary">
                <div class="summary-item">
                    <span class="summary-value total">@historyItems.Count</span>
                    <span class="summary-label">Total Checks</span>
                </div>
                <div class="summary-separator-vertical"></div>
                <div class="summary-item">
                    <span class="summary-value critical">@GetCriticalCount()</span>
                    <span class="summary-label">Critical</span>
                </div>
                <div class="summary-separator-vertical"></div>
                <div class="summary-item">
                    <span class="summary-value safe">@GetSafeCount()</span>
                    <span class="summary-label">Safe</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="history-filters">
        <div class="search-container">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="search-icon">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" @bind="searchQuery" @bind:event="oninput" class="search-input" placeholder="Search by Patient Name or Drug" />
        </div>
        <div class="filter-container">
            <div class="custom-select-wrapper">
                <select @bind="selectedRiskFilter" @bind:event="onchange" class="filter-select risk-select">
                    <option value="all">All Risks</option>
                    <option value="critical">Critical</option>
                    <option value="moderate">Moderate</option>
                    <option value="minor">Minor</option>
                    <option value="safe">Safe</option>
                </select>
                <img src="images/WarningBlack.svg" alt="" class="select-icon" />
            </div>
            <div class="custom-select-wrapper">
                <select @bind="selectedSortBy" @bind:event="onchange" class="filter-select sort-select">
                    <option value="date">Sort By Date</option>
                    <option value="name">Sort By Name</option>
                    <option value="risk">Sort By Risk</option>
                </select>
                @if (selectedSortBy == "date" || selectedSortBy == "risk")
                {
                    <img src="images/WarningBlack.svg" alt="" class="select-icon" />
                }
            </div>
        </div>
    </div>

    <!-- History List -->
    @if (isLoading)
    {
        <div style="text-align: center; padding: 4rem;">
            <div style="font-size: 1.2rem; color: #666;">Loading history...</div>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div style="text-align: center; padding: 4rem;">
            <div style="font-size: 1.2rem; color: #EF4444;">@errorMessage</div>
            <button type="button" @onclick="LoadHistoryAsync" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4994FF; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Retry
            </button>
        </div>
    }
    else if (filteredHistoryItems.Any())
    {
        <div class="history-list">
            @foreach (var item in filteredHistoryItems)
            {
                <div class="history-card">
                    <div class="history-card-header">
                        <div class="patient-avatar">
                            <span>@GetInitials(item.PatientName)</span>
                        </div>
                        <div class="patient-info">
                            <h3 class="patient-name">@item.PatientName</h3>
                            <p class="patient-details">
                                <img src="images/PersonGrey.png" alt="" class="inline-icon" />
                                @item.Age years old • @item.Gender
                            </p>
                        </div>
                        <div class="risk-badge @item.RiskLevel.ToLower()">
                            @if (item.RiskLevel == "critical")
                            {
                                <img src="images/XIcon.svg" alt="" class="risk-badge-icon" />
                            }
                            else if (item.RiskLevel == "moderate")
                            {
                                <img src="images/WarningYellow.png" alt="" class="risk-badge-icon" />
                            }
                            else if (item.RiskLevel == "safe")
                            {
                                <img src="images/Allowed.png" alt="" class="risk-badge-icon" />
                            }
                            <span>@item.RiskLevel</span>
                        </div>
                    </div>
                    
                    @if (item.Tags.Any())
                    {
                        <div class="patient-tags">
                            @foreach (var tag in item.Tags)
                            {
                                <span class="patient-tag @tag.ToLower()">@tag</span>
                            }
                        </div>
                    }

                    <div class="medications-section">
                        <div class="medications-header">
                            <img src="images/CapsuleGrey.png" alt="" class="medications-icon" />
                            <span>Medications (@item.Medications.Count)</span>
                        </div>
                        <div class="medications-list">
                            @foreach (var medication in item.Medications)
                            {
                                <span class="medication-item">@medication</span>
                            }
                        </div>
                        <div class="risk-indicators">
                            @if (item.CriticalCount > 0)
                            {
                                <span class="risk-indicator critical">
                                    <span class="risk-dot critical"></span>
                                    @item.CriticalCount Critical
                                </span>
                            }
                            @if (item.ModerateCount > 0)
                            {
                                <span class="risk-indicator moderate">
                                    <span class="risk-dot moderate"></span>
                                    @item.ModerateCount Moderate
                                </span>
                            }
                            @if (item.MinorCount > 0)
                            {
                                <span class="risk-indicator minor">
                                    <span class="risk-dot minor"></span>
                                    @item.MinorCount Minor
                                </span>
                            }
                        </div>
                    </div>

                    <div class="history-card-footer">
                        @if (!string.IsNullOrEmpty(item.Timestamp))
                        {
                            <span class="timestamp">
                                @{
                                    var timestampParts = item.Timestamp.Split('•');
                                    if (timestampParts.Length == 2)
                                    {
                                        <span class="timestamp-date">
                                            <img src="images/CalendarGrey.png" alt="" class="timestamp-icon" />
                                            @timestampParts[0].Trim()
                                        </span>
                                        <span class="timestamp-time">
                                            <img src="images/ClockGrey.svg" alt="" class="timestamp-icon" />
                                            @timestampParts[1].Trim()
                                        </span>
                                    }
                                    else
                                    {
                                        <img src="images/CalendarGrey.png" alt="" class="timestamp-icon" />
                                        @item.Timestamp
                                    }
                                }
                            </span>
                        }
                        <div class="history-card-actions">
                            <button class="view-details-btn" @onclick="() => ViewDetails(item)">
                                <img src="images/EyeIcon.svg" alt="" class="view-details-icon" />
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3H21V21H3V3Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 3V21" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 7H21" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2 class="empty-title">No history yet</h2>
            <p class="empty-description">Your drug interaction check history will appear here</p>
            <a href="/dashboard/drug-checker" class="empty-action">Start Checking</a>
        </div>
    }
</div>

<style>
    .history-page {
        padding: 2rem;
        min-height: calc(100vh - 150px);
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: transparent;
        position: relative;
    }

    .history-header-container {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
    }

    .history-header-left {
        flex: 1;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #4994FF;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 1rem;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: #357abd;
    }

    .back-link svg {
        width: 16px;
        height: 16px;
    }

    .history-title {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }

    .history-summary {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .summary-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: center;
        text-align: center;
    }

    .summary-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
    }

    .summary-value {
        font-size: 24px;
        font-weight: 700;
        line-height: 1;
    }

    .summary-separator-vertical {
        width: 1px;
        height: 40px;
        background: #e5e7eb;
    }

    .summary-value.total {
        color: #4994FF;
    }

    .summary-value.critical {
        color: #EF4444;
    }

    .summary-value.safe {
        color: #10B981;
    }

    .history-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
    }

    .search-container {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        color: #9ca3af;
        pointer-events: none;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #4994FF;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .filter-container {
        display: flex;
        gap: 1rem;
    }

    .custom-select-wrapper {
        position: relative;
        display: inline-block;
    }

    .custom-select-wrapper .select-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        pointer-events: none;
        z-index: 1;
    }

    .filter-select {
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%234D4D4D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px 8px;
        transition: all 0.3s ease;
    }

    .filter-select.sort-select,
    .filter-select.risk-select {
        padding-left: 2.5rem;
    }

    .filter-select:focus {
        outline: none;
        border-color: #4994FF;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center;
    }

    .history-card {
        width: 100%;
        max-width: 100%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    .history-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .history-card-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .patient-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #4994FF;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
    }

    .patient-info {
        flex: 1;
    }

    .patient-name {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 0.25rem 0;
    }

    .patient-details {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .inline-icon {
        width: 16px;
        height: 16px;
        object-fit: contain;
    }

    .risk-badge {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        text-transform: capitalize;
    }

    .risk-badge.safe {
        background: #DCFCE7;
        color: #10B981;
        border: 1px solid #b9fcd0;
    }

    .risk-badge.critical {
        background: #FEF2F2;
        color: #C10007;
        border: 1px solid #FFC9C9;
    }

    .risk-badge.moderate {
        background: #FFF8F0;
        color: #FFB050;
        border: 1px solid rgba(255, 176, 80, 0.2);
    }

    .risk-badge.minor {
        background: #FEF9C3;
        color: #CA8A04;
        border: 1px solid #FAF07E;
    }

    .risk-badge-icon {
        width: 14px;
        height: 14px;
        object-fit: contain;
    }

    .patient-tags {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .patient-tag {
        padding: 0.375rem 0.75rem;
        border-radius: 50px;
        font-size: 12px;
        line-height: 16px;
        font-weight: 600;
    }

    .patient-tag.pregnant {
        background: #FDF2F8;
        color: #C6005C;
        border:#FCCEE8 1px solid;
    }

    .patient-tag.breastfeeding {
        background: #FAF5FF;
        color: #8200DB;
        border: 1px solid #E9D4FF;
    }

    .medications-section {
        margin-bottom: 0;
    }

    .medications-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
    }

    .medications-icon {
        width: 18px;
        height: 18px;
        object-fit: contain;
    }

    .medications-list {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
        gap: 0.5rem;
    }

    .medication-item {
        padding: 0.5rem 0.75rem;
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 10px;
        font-size: 14px;
        color: #364153;
        font-weight: 400;
    }

    .history-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .risk-indicators {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 0.75rem
    }

    .risk-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 13px;
        color: #6b7280;
    }


    .footer-separator {
        width: 1px;
        height: 20px;
        background: #e5e7eb;
        margin: 0 1rem;
    }

    .history-card-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .timestamp {
        font-size: 13px;
        color: #9ca3af;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .timestamp-date,
    .timestamp-time {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .timestamp-icon {
        width: 14px;
        height: 14px;
        object-fit: contain;
    }

    .view-details-btn {
        padding: 0.5rem 1.5rem;
        background: #4994FF;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .view-details-icon {
        width: 16px;
        height: 16px;
        object-fit: contain;
    }

    .view-details-btn:hover {
        background: #357abd;
        transform: translateY(-1px);
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .empty-state svg {
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 24px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 0.5rem 0;
    }

    .empty-description {
        font-size: 16px;
        color: #6b7280;
        margin: 0 0 2rem 0;
    }

    .empty-action {
        display: inline-block;
        padding: 0.75rem 2rem;
        background: #4994FF;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .empty-action:hover {
        background: #357abd;
        transform: translateY(-1px);
    }

    @@media (max-width: 768px) {
        .history-page {
            padding: 0.75rem 0.75rem;
            min-height: auto;
            height: calc(100vh - 150px);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .history-header-container {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .history-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .history-title {
            font-size: 20px;
        }

        .history-summary {
            width: 100%;
            justify-content: space-around;
            gap: 1rem;
        }

        .summary-item {
            gap: 0.125rem;
        }

        .summary-value {
            font-size: 18px;
        }

        .summary-label {
            font-size: 10px;
        }

        .summary-separator-vertical {
            height: 30px;
        }

        .history-filters {
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .search-input {
            padding: 0.625rem 0.875rem 0.625rem 2.5rem;
            font-size: 12px;
        }

        .search-icon {
            left: 0.875rem;
            width: 16px;
            height: 16px;
        }

        .filter-container {
            width: 100%;
            gap: 0.75rem;
        }

        .filter-select {
            flex: 1;
            padding: 0.625rem 2rem 0.625rem 2rem;
            font-size: 12px;
        }

        .history-list {
            gap: 1rem;
        }

        .history-card {
            width: 100%;
            padding: 1rem;
        }

        .history-card-header {
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .patient-avatar {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }

        .patient-name {
            font-size: 16px;
        }

        .patient-details {
            font-size: 12px;
        }

        .risk-badge {
            padding: 0.25rem 0.5rem;
            font-size: 10px;
        }

        .risk-badge-icon {
            width: 12px;
            height: 12px;
        }

        .patient-tags {
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .patient-tag {
            padding: 0.25rem 0.5rem;
            font-size: 10px;
        }

        .medications-section {
            margin-bottom: 0;
        }

        .medications-header {
            font-size: 12px;
            margin-bottom: 0.5rem;
        }

        .medications-icon {
            width: 16px;
            height: 16px;
        }

        .medications-list {
            gap: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .medication-item {
            padding: 0.375rem 0.625rem;
            font-size: 11px;
        }

        .risk-indicators {
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .risk-indicator {
            font-size: 11px;
            gap: 0.375rem;
        }

        .risk-dot {
            width: 6px;
            height: 6px;
        }

        .history-card-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            padding-top: 0.75rem;
        }

        .timestamp {
            font-size: 11px;
            gap: 0.375rem;
        }

        .timestamp-icon {
            width: 12px;
            height: 12px;
        }

        .history-card-actions {
            width: 100%;
            justify-content: space-between;
        }

        .view-details-btn {
            padding: 0.5rem 1.25rem;
            font-size: 12px;
        }

        .view-details-icon {
            width: 14px;
            height: 14px;
        }

        .footer-separator {
            display: none;
        }

        .empty-state {
            padding: 2rem 1rem;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 18px;
        }

        .empty-description {
            font-size: 13px;
            margin-bottom: 1.5rem;
        }

        .empty-action {
            padding: 0.625rem 1.5rem;
            font-size: 12px;
        }
    }
</style>

@code {
    private string searchQuery = "";
    private string selectedRiskFilter = "all";
    private string selectedSortBy = "date";
    private bool isLoading = true;
    private string? errorMessage;

    private class HistoryItem
    {
        public string PatientName { get; set; } = "";
        public int Age { get; set; }
        public string Gender { get; set; } = "";
        public List<string> Tags { get; set; } = new();
        public List<string> Medications { get; set; } = new();
        public string RiskLevel { get; set; } = "";
        public int CriticalCount { get; set; }
        public int ModerateCount { get; set; }
        public int MinorCount { get; set; }
        public string Timestamp { get; set; } = "";
    }

    private List<HistoryItem> historyItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadHistoryAsync();
    }

    private async Task LoadHistoryAsync()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // TODO: Replace with actual API endpoint
            // var response = await Http.GetFromJsonAsync<List<HistoryItem>>("/api/drug-interaction/history");
            // if (response != null)
            // {
            //     historyItems = response;
            // }

            // Fallback to mock data for now
            await Task.Delay(300); // Simulate API delay
            historyItems = new List<HistoryItem>
            {
                new HistoryItem
                {
                    PatientName = "Sarah Johnson",
                    Age = 34,
                    Gender = "Female",
                    Tags = new List<string> { "Pregnant" },
                    Medications = new List<string> { "Aspirin", "Warfarin", "Ibuprofen" },
                    RiskLevel = "Critical",
                    CriticalCount = 2,
                    ModerateCount = 1,
                    MinorCount = 0,
                    Timestamp = "11 hours ago • 02:30 PM"
                },
                new HistoryItem
                {
                    PatientName = "Ahmed Hassan",
                    Age = 45,
                    Gender = "Male",
                    Tags = new List<string>(),
                    Medications = new List<string> { "Metformin", "Lisinopril" },
                    RiskLevel = "Safe",
                    CriticalCount = 0,
                    ModerateCount = 0,
                    MinorCount = 0,
                    Timestamp = "Yesterday • 10:15 AM"
                },
                new HistoryItem
                {
                    PatientName = "Fatima Ali",
                    Age = 28,
                    Gender = "Female",
                    Tags = new List<string> { "Breastfeeding" },
                    Medications = new List<string> { "Omeprazole", "Clopidogrel", "Simvastatin" },
                    RiskLevel = "Moderate",
                    CriticalCount = 0,
                    ModerateCount = 2,
                    MinorCount = 0,
                    Timestamp = "Feb 10, 2026 • 04:45 PM"
                },
                new HistoryItem
                {
                    PatientName = "Mohammed Khaled",
                    Age = 52,
                    Gender = "Male",
                    Tags = new List<string>(),
                    Medications = new List<string> { "Atorvastatin", "Amlodipine", "Metoprolol" },
                    RiskLevel = "Minor",
                    CriticalCount = 0,
                    ModerateCount = 0,
                    MinorCount = 1,
                    Timestamp = "Feb 9, 2026 • 09:20 AM"
                },
                new HistoryItem
                {
                    PatientName = "Layla Ahmed",
                    Age = 29,
                    Gender = "Female",
                    Tags = new List<string>(),
                    Medications = new List<string> { "Paracetamol", "Vitamin D" },
                    RiskLevel = "Safe",
                    CriticalCount = 0,
                    ModerateCount = 0,
                    MinorCount = 0,
                    Timestamp = "Feb 8, 2026 • 11:20 AM"
                },
                new HistoryItem
                {
                    PatientName = "Omar Ibrahim",
                    Age = 38,
                    Gender = "Male",
                    Tags = new List<string>(),
                    Medications = new List<string> { "Amoxicillin", "Ibuprofen" },
                    RiskLevel = "Safe",
                    CriticalCount = 0,
                    ModerateCount = 0,
                    MinorCount = 0,
                    Timestamp = "Feb 7, 2026 • 03:15 PM"
                }
            };
        }
        catch (Exception ex)
        {
            // TODO: Add proper error handling/logging
            errorMessage = $"Error loading history: {ex.Message}";
            Console.WriteLine(errorMessage);
            historyItems = new List<HistoryItem>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private List<HistoryItem> filteredHistoryItems
    {
        get
        {
            if (historyItems == null)
                return new List<HistoryItem>();
                
            var filtered = historyItems.AsEnumerable();

            // Filter by search query
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var query = searchQuery.ToLower();
                filtered = filtered.Where(item =>
                    item.PatientName.ToLower().Contains(query) ||
                    item.Medications.Any(m => m.ToLower().Contains(query))
                );
            }

            // Filter by risk level
            if (selectedRiskFilter != "all")
            {
                filtered = filtered.Where(item => item.RiskLevel.ToLower() == selectedRiskFilter.ToLower());
            }

            // Sort
            filtered = selectedSortBy switch
            {
                "name" => filtered.OrderBy(item => item.PatientName),
                "risk" => filtered.OrderByDescending(item => GetRiskPriority(item.RiskLevel)),
                _ => filtered.OrderByDescending(item => ParseTimestamp(item.Timestamp))
            };

            return filtered.ToList();
        }
    }

    private int GetCriticalCount()
    {
        if (historyItems == null)
            return 0;
        return historyItems.Count(item => item.RiskLevel.ToLower() == "critical");
    }

    private int GetSafeCount()
    {
        if (historyItems == null)
            return 0;
        return historyItems.Count(item => item.RiskLevel.ToLower() == "safe");
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return name[0].ToString().ToUpper();
    }

    private int GetRiskPriority(string riskLevel)
    {
        return riskLevel.ToLower() switch
        {
            "critical" => 4,
            "moderate" => 3,
            "minor" => 2,
            "safe" => 1,
            _ => 0
        };
    }

    private DateTime ParseTimestamp(string timestamp)
    {
        // TODO: In real app, HistoryItem should have a DateTime property instead of string
        // For now, simple parsing for sorting
        if (timestamp.Contains("hours ago") || timestamp.Contains("Yesterday"))
            return DateTime.Now.AddDays(-1);
        if (timestamp.Contains("Feb"))
            return DateTime.Parse("2026-02-10");
        return DateTime.Now;
    }

    private void ViewDetails(HistoryItem item)
    {
        // Navigate to drug interaction results page (stay in dashboard)
        Navigation.NavigateTo("/dashboard/drug-interaction-results");
    }
}
