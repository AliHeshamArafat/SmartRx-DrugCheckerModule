@using SmartRx_DrugChecker.Pages
@implements IDisposable
@inject NavigationManager Navigation
@inject IJSRuntime JS

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<div id="drug-interaction-form" class="drug-interaction-form-page">
    <!-- Plan Banner -->
    <div class="plan-banner">
        <div class="plan-banner-content">
            <div class="plan-info">
                <span class="plan-label">Current Plan</span>
                <span class="plan-name">@CurrentPlan</span>
            </div>
            <div class="tokens-info">
                <span class="tokens-label">Tokens Remaining</span>
                <span class="tokens-count">@TokensRemaining</span>
            </div>
        </div>
    </div>
    
    <div class="form-container">
        <!-- Left Panel: Form Sections -->
        <div class="form-sections">
            <!-- Patient Information Section -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-icon">
                        <img src="images/User.png" alt="User" />
                    </span>
                    <h2 class="section-title">Patient Information</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select @bind="patientInfo.Gender" @bind:event="onchange" id="gender" class="form-input form-select">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">Birth Date</label>
                        <input type="date" @bind="BirthDate" @bind:event="onchange" id="birthDate" class="form-input form-date" placeholder="mm/dd/yyyy" />
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <div class="age-input-container">
                            <div class="age-input-part">
                                <input type="number" @bind="AgeYears" @bind:event="onchange" id="ageYears" class="form-input age-input" placeholder="Y" min="0" />
                                <span class="age-label">Years</span>
                            </div>
                            <div class="age-input-part">
                                <input type="number" @bind="AgeMonths" @bind:event="onchange" id="ageMonths" class="form-input age-input" placeholder="M" min="0" max="11" />
                                <span class="age-label">Months</span>
                            </div>
                            <div class="age-input-part">
                                <input type="number" @bind="AgeDays" @bind:event="onchange" id="ageDays" class="form-input age-input" placeholder="D" min="0" max="30" />
                                <span class="age-label">Days</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" @bind="patientInfo.Weight" @bind:event="onchange" id="weight" class="form-input" placeholder="Enter Weight" step="0.1" />
                    </div>
                </div>
            </div>

            <!-- Select Drugs Section -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-icon">
                        <img src="images/Capsule.png" alt="Capsule" />
                    </span>
                    <h2 class="section-title">Select Drugs</h2>
                </div>
                <div class="search-container search-container-with-icon">
                    <span class="search-icon-wrapper">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <input type="text" @bind="DrugSearchQuery" @bind:event="oninput" 
                           class="search-input search-input-with-icon" placeholder="Search by brand or generic name..." />
                </div>
                @if (drugSearchResults.Any() && !string.IsNullOrWhiteSpace(drugSearchQuery))
                {
                    <div class="drug-search-results">
                        @foreach (var drug in drugSearchResults)
                        {
                            <div class="drug-result-item" @onclick="() => AddDrugFromSearch(drug)">
                                <span class="drug-result-name">@drug.Name</span>
                                @if (!string.IsNullOrEmpty(drug.GenericName))
                                {
                                    <span class="drug-result-generic">(@drug.GenericName)</span>
                                }
                            </div>
                        }
                    </div>
                }
                @if (selectedDrugs.Any())
                {
                    <div class="selected-drugs">
                        @foreach (var drug in selectedDrugs)
                        {
                            <div class="drug-item">
                                <div class="drug-info">
                                    <span class="drug-name">@drug.Name</span>
                                    @if (!string.IsNullOrEmpty(drug.GenericName))
                                    {
                                        <span class="drug-generic">(@drug.GenericName)</span>
                                    }
                                </div>
                                <div class="drug-actions">
                                    <button type="button" class="list-button" @onclick="() => OpenCalculatorAsync(drug)">
                                        <img src="images/Calculator.png" alt="Calculator" class="calculator-icon" />
                                    </button>
                                    <button type="button" @onclick="() => RemoveDrug(drug)" class="remove-button">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Safety Check Options Section -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-icon section-icon-safety">
                        <img src="images/Baby.png" alt="Baby" />
                    </span>
                    <h2 class="section-title">Safety Check Options</h2>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label custom-checkbox">
                        <input type="checkbox" @bind="safetyOptions.CheckPregnancy" @bind:event="onchange" class="custom-checkbox-input" />
                        <span class="custom-checkbox-mark @(safetyOptions.CheckPregnancy ? "checked" : "")"></span>
                        <span class="checkbox-text">Check Pregnancy Risks</span>
                    </label>
                    <label class="checkbox-label custom-checkbox">
                        <input type="checkbox" @bind="safetyOptions.CheckLactation" @bind:event="onchange" class="custom-checkbox-input" />
                        <span class="custom-checkbox-mark @(safetyOptions.CheckLactation ? "checked" : "")"></span>
                        <span class="checkbox-text">Check Lactation Risks</span>
                    </label>
                </div>
            </div>

            <!-- Diagnoses / Conditions Section -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-icon section-icon-diagnoses">
                        <img src="images/Examine.png" alt="Examine" />
                    </span>
                    <h2 class="section-title">Diagnoses / Conditions <span class="optional-text">(Optional)</span></h2>
                </div>
                <div class="search-container search-container-inline">
                    <input type="text" @bind="conditionSearchQuery" @bind:event="oninput" @onkeypress="@(e => { if (e.Key == "Enter") AddCondition(); })" 
                           class="search-input" placeholder="Search and add conditions..." />
                    <button type="button" @onclick="AddCondition" class="add-button-inline">+</button>
                </div>
                @if (conditions.Any())
                {
                    <div class="tags-container">
                        @foreach (var condition in conditions)
                        {
                            <span class="tag tag-condition">
                                @condition
                                <button type="button" @onclick="() => RemoveCondition(condition)" class="tag-remove">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </span>
                        }
                    </div>
                }
            </div>

            <!-- Known Drug Allergies Section -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-icon section-icon-allergies">
                        <img src="images/Warning.png" alt="Warning" />
                    </span>
                    <h2 class="section-title">Known Drug Allergies <span class="optional-text">(Optional)</span></h2>
                </div>
                <div class="search-container search-container-inline">
                    <input type="text" @bind="allergySearchQuery" @bind:event="oninput" @onkeypress="@(e => { if (e.Key == "Enter") AddAllergy(); })" 
                           class="search-input" placeholder="Search and add allergies..." />
                    <button type="button" @onclick="AddAllergy" class="add-button-inline">+</button>
                </div>
                @if (allergies.Any())
                {
                    <div class="tags-container">
                        @foreach (var allergy in allergies)
                        {
                            <span class="tag tag-allergy">
                                @allergy
                                <button type="button" @onclick="() => RemoveAllergy(allergy)" class="tag-remove">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </span>
                        }
                    </div>
                }
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button" @onclick="CheckDrugSafety" class="btn-check-safety">
                    <img src="images/Stars.png" alt="Stars" class="btn-check-icon" />
                    Check Drug Safety
                </button>
                <button type="button" @onclick="ClearAll" class="btn-clear">Clear All</button>
            </div>
        </div>

        <!-- Right Panel: Summary and Ads -->
        <div class="right-panel-wrapper">
            <div class="summary-panel">
                <h2 class="summary-title">Summary</h2>
                <div class="summary-items">
                    <div class="summary-item">
                        <span class="summary-icon">
                            <img src="images/Capsule.png" alt="Capsule" />
                        </span>
                        <span class="summary-label">Drugs selected</span>
                        <span class="summary-count">@selectedDrugs.Count</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-icon">
                            <img src="images/Examine.png" alt="Examine" />
                        </span>
                        <span class="summary-label">Conditions</span>
                        <span class="summary-count">@conditions.Count</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-icon">
                            <img src="images/Warning.png" alt="Warning" />
                        </span>
                        <span class="summary-label">Allergies</span>
                        <span class="summary-count">@allergies.Count</span>
                    </div>
                    <div class="summary-separator"></div>
                    <div class="summary-item summary-item-vertical">
                        <span class="summary-icon">
                            <img src="images/Baby.png" alt="Baby" />
                        </span>
                        <div class="summary-content">
                            <span class="summary-label">Pregnancy check</span>
                            <span class="summary-status @(safetyOptions.CheckPregnancy ? "on" : "off")">@(safetyOptions.CheckPregnancy ? "On" : "Off")</span>
                        </div>
                    </div>
                    <div class="summary-item summary-item-vertical">
                        <span class="summary-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <div class="summary-content">
                            <span class="summary-label">Lactation check</span>
                            <span class="summary-status @(safetyOptions.CheckLactation ? "on" : "off")">@(safetyOptions.CheckLactation ? "On" : "Off")</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ads Container -->
            <div class="ads-container" @onmouseenter="PauseAutoScroll" @onmouseleave="ResumeAutoScroll">
                <div class="ads-carousel-wrapper">
                    <div class="ads-carousel" style="transform: translateY(-@(currentAdIndex * 100)%);">
                        @foreach (var ad in ads)
                        {
                            <div class="ad-item">
                                <img src="@ad" alt="Advertisement" />
                            </div>
                        }
                    </div>
                </div>
                @if (ads.Count > 1)
                {
                    <div class="ads-indicators">
                        @for (int i = 0; i < ads.Count; i++)
                        {
                            <span class="ads-indicator @(i == currentAdIndex ? "active" : "")" @onclick="() => GoToAd(i)"></span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<DrugDoseCalculatorModal IsOpen="isCalculatorModalOpen"
                         DrugName="@(calculatorSelectedDrug?.Name ?? string.Empty)"
                         CalculatorData="calculatorData"
                         OnClose="CloseCalculator" />

@code {
    // Patient Information Model
    private class PatientInfo
    {
        public string Gender { get; set; } = "";
        public DateTime? BirthDate { get; set; }
        public int? AgeYears { get; set; }
        public int? AgeMonths { get; set; }
        public int? AgeDays { get; set; }
        public decimal? Weight { get; set; }
    }

    // Drug Model
    private class Drug
    {
        public string Name { get; set; } = "";
        public string GenericName { get; set; } = "";
    }

    // Safety Options Model
    private class SafetyOptions
    {
        public bool CheckPregnancy { get; set; } = false;
        public bool CheckLactation { get; set; } = false;
    }

    private PatientInfo patientInfo = new();
    private SafetyOptions safetyOptions = new();
    private List<Drug> selectedDrugs = new();
    private List<Drug> drugSearchResults = new();
    private List<string> conditions = new();
    private List<string> allergies = new();

    private bool isCalculatorModalOpen = false;
    private Drug? calculatorSelectedDrug;
    private string? calculatorData;
    private bool isUpdatingFromAge = false;

    private string drugSearchQuery = "";
    private string conditionSearchQuery = "";
    private string allergySearchQuery = "";

    // Plan and Tokens (TODO: Replace with actual data from API/service)
    private string CurrentPlan { get; set; } = "Individual";
    private int TokensRemaining { get; set; } = 150;

    // Ads carousel
    private List<string> ads = new()
    {
        "images/ad1.jpg", // Replace with actual ad image paths
        "images/ad2.jpg",
        "images/ad3.jpg"
    };
    private int currentAdIndex = 0;
    private System.Threading.Timer? autoScrollTimer;
    private bool isAutoScrollPaused = false;

    private string DrugSearchQuery
    {
        get => drugSearchQuery;
        set
        {
            drugSearchQuery = value;
            SearchDrug();
        }
    }

    private DateTime? BirthDate
    {
        get => patientInfo.BirthDate;
        set
        {
            patientInfo.BirthDate = value;
            if (!isUpdatingFromAge)
            {
                CalculateAge();
            }
        }
    }

    private int? AgeYears
    {
        get => patientInfo.AgeYears;
        set
        {
            patientInfo.AgeYears = value;
            CalculateBirthDateFromAge();
        }
    }

    private int? AgeMonths
    {
        get => patientInfo.AgeMonths;
        set
        {
            patientInfo.AgeMonths = value;
            CalculateBirthDateFromAge();
        }
    }

    private int? AgeDays
    {
        get => patientInfo.AgeDays;
        set
        {
            patientInfo.AgeDays = value;
            CalculateBirthDateFromAge();
        }
    }

    private void CalculateAge()
    {
        if (patientInfo.BirthDate.HasValue)
        {
            var today = DateTime.Today;
            var birthDate = patientInfo.BirthDate.Value.Date;
            
            // Calculate years
            var years = today.Year - birthDate.Year;
            var months = today.Month - birthDate.Month;
            var days = today.Day - birthDate.Day;
            
            // Adjust if current day is before birth day in current month
            if (days < 0)
            {
                months--;
                var lastMonth = today.AddMonths(-1);
                days += DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month);
            }
            
            // Adjust if current month is before birth month
            if (months < 0)
            {
                years--;
                months += 12;
            }
            
            // Adjust if current date is before birth date in current year
            if (years < 0 || (years == 0 && (months < 0 || (months == 0 && days < 0))))
            {
                years = 0;
                months = 0;
                days = 0;
            }
            
            patientInfo.AgeYears = years;
            patientInfo.AgeMonths = months;
            patientInfo.AgeDays = days;
        }
        else
        {
            patientInfo.AgeYears = null;
            patientInfo.AgeMonths = null;
            patientInfo.AgeDays = null;
        }
    }

    private void CalculateBirthDateFromAge()
    {
        // Only calculate if at least one age field has a value
        if (patientInfo.AgeYears.HasValue || patientInfo.AgeMonths.HasValue || patientInfo.AgeDays.HasValue)
        {
            var today = DateTime.Today;
            var years = patientInfo.AgeYears ?? 0;
            var months = patientInfo.AgeMonths ?? 0;
            var days = patientInfo.AgeDays ?? 0;

            // Validate age values
            if (years < 0) years = 0;
            if (months < 0 || months > 11) months = Math.Max(0, Math.Min(11, months));
            if (days < 0 || days > 30) days = Math.Max(0, Math.Min(30, days));

            // Calculate birth date by subtracting age from today
            var calculatedBirthDate = today
                .AddYears(-years)
                .AddMonths(-months)
                .AddDays(-days);

            // Ensure the birth date is not in the future
            if (calculatedBirthDate > today)
            {
                calculatedBirthDate = today;
            }

            // Set flag to prevent circular update
            isUpdatingFromAge = true;
            patientInfo.BirthDate = calculatedBirthDate;
            isUpdatingFromAge = false;
        }
        else
        {
            // If all age fields are empty, clear the birth date
            isUpdatingFromAge = true;
            patientInfo.BirthDate = null;
            isUpdatingFromAge = false;
        }
    }

    private void SearchDrug()
    {
        if (string.IsNullOrWhiteSpace(drugSearchQuery))
        {
            drugSearchResults.Clear();
            return;
        }

        // Mock drug search - in real implementation, this would call an API
        // For now, simulate search results
        drugSearchResults = new List<Drug>
        {
            new Drug { Name = drugSearchQuery, GenericName = $"{drugSearchQuery} Generic" },
            new Drug { Name = $"{drugSearchQuery} Plus", GenericName = $"{drugSearchQuery} Generic Plus" }
        };
    }

    private void AddDrugFromSearch(Drug drug)
    {
        if (!selectedDrugs.Any(d => d.Name == drug.Name))
        {
            selectedDrugs.Add(drug);
            drugSearchQuery = "";
            drugSearchResults.Clear();
        }
    }

    private void RemoveDrug(Drug drug)
    {
        selectedDrugs.Remove(drug);
    }

    private async Task OpenCalculatorAsync(Drug drug)
    {
        calculatorSelectedDrug = drug;
        isCalculatorModalOpen = true;

        // Lock background scroll while modal is open
        if (JS != null)
        {
            await JS.InvokeVoidAsync("smartRxModal.lockBodyScroll", true);
        }

        // Placeholder for fetching calculator data from an endpoint
        // Example:
        // calculatorData = await httpClient.GetFromJsonAsync<string>($"/api/drug-calculator/{drug.Name}");

        // For now, keep static/example content
        calculatorData = $"Static calculator data for {drug.Name} (replace with API response).";
    }

    private async Task CloseCalculator()
    {
        isCalculatorModalOpen = false;
        calculatorSelectedDrug = null;
        calculatorData = null;

        // Re-enable background scroll when modal closes
        if (JS != null)
        {
            await JS.InvokeVoidAsync("smartRxModal.lockBodyScroll", false);
        }
    }

    private void AddCondition()
    {
        if (!string.IsNullOrWhiteSpace(conditionSearchQuery) && !conditions.Contains(conditionSearchQuery))
        {
            conditions.Add(conditionSearchQuery);
            conditionSearchQuery = "";
        }
    }

    private void RemoveCondition(string condition)
    {
        conditions.Remove(condition);
    }

    private void AddAllergy()
    {
        if (!string.IsNullOrWhiteSpace(allergySearchQuery) && !allergies.Contains(allergySearchQuery))
        {
            allergies.Add(allergySearchQuery);
            allergySearchQuery = "";
        }
    }

    private void RemoveAllergy(string allergy)
    {
        allergies.Remove(allergy);
    }

    private void CheckDrugSafety()
    {
        // Collect all the form data
        var formData = new
        {
            PatientInfo = patientInfo,
            SelectedDrugs = selectedDrugs,
            SafetyOptions = safetyOptions,
            Conditions = conditions,
            Allergies = allergies
        };

        // TODO: In the future, send formData to your backend API
        // Example: 
        // var response = await httpClient.PostAsJsonAsync("/api/drug-interaction/check", formData);
        // var results = await response.Content.ReadFromJsonAsync<DrugInteractionResults>();
        // Then pass results to the results page via navigation state or session storage

        // Check if we're in the dashboard context
        var currentUri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var isInDashboard = currentUri.AbsolutePath.StartsWith("/dashboard", StringComparison.OrdinalIgnoreCase);
        
        // Navigate to the appropriate results page based on context
        var resultsRoute = isInDashboard ? "/dashboard/drug-interaction-results" : "/drug-interaction-results";
        Navigation.NavigateTo(resultsRoute);
    }

    private void ClearAll()
    {
        patientInfo = new PatientInfo();
        safetyOptions = new SafetyOptions();
        selectedDrugs.Clear();
        drugSearchResults.Clear();
        conditions.Clear();
        allergies.Clear();
        drugSearchQuery = "";
        conditionSearchQuery = "";
        allergySearchQuery = "";
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && ads.Count > 1)
        {
            StartAutoScroll();
        }
    }

    private void StartAutoScroll()
    {
        if (ads.Count <= 1) return;
        
        autoScrollTimer = new System.Threading.Timer(_ =>
        {
            if (!isAutoScrollPaused)
            {
                InvokeAsync(() =>
                {
                    currentAdIndex = (currentAdIndex + 1) % ads.Count;
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private void PauseAutoScroll()
    {
        isAutoScrollPaused = true;
    }

    private void ResumeAutoScroll()
    {
        isAutoScrollPaused = false;
    }

    private void GoToAd(int index)
    {
        currentAdIndex = index;
        StateHasChanged();
    }

    public void Dispose()
    {
        autoScrollTimer?.Dispose();
    }
}

<style>
    .drug-interaction-form-page {
        min-height: 100vh;
        padding: 2rem;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: transparent;
        position: relative;
    }

    .plan-banner {
        max-width: 1440px;
        margin: 0 auto 2rem auto;
        border-radius: 12px;
        padding: 1.5rem 2rem;
        background: #FFFFFF;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(73, 148, 255, 0.2);
    }

    .plan-banner::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(206.06deg, #4994FF 19%, #3D76C7 83.58%);
        background-blend-mode: multiply;
        z-index: 0;
    }

    .plan-banner::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(58.33% 5.78% at 50% 91.11%, rgba(73, 148, 255, 0.5) 0%, rgba(255, 255, 255, 0) 100%);
        z-index: 1;
    }

    .plan-banner-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
        position: relative;
        z-index: 2;
    }

    .plan-info,
    .tokens-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .plan-label,
    .tokens-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .plan-name,
    .tokens-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #FFFFFF;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    @@media (max-width: 768px) {
        .plan-banner {
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .plan-banner-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .plan-name,
        .tokens-count {
            font-size: 1.25rem;
        }
    }

    .form-container {
        max-width: 1440px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        align-items: start;
        position: relative;
        z-index: 1;
    }

    @@media (min-width: 1280px) and (max-width: 1366px) {
        .form-container {
            gap: 1.5rem;
            padding: 0 1rem;
        }

        .form-section {
            padding: 1.25rem;
        }

        .section-title {
            font-size: 1.15rem;
        }

        .right-panel-wrapper {
            top: 100px;
        }

        .summary-panel {
            padding: 1.125rem;
        }

        .ads-container {
            min-height: 280px;
        }

        .ads-carousel-wrapper {
            height: 280px;
        }
    }

    .right-panel-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        position: sticky;
        top: 20px;
        height: fit-content;
        align-self: start;
    }

    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-section {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .section-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        color: #4D4D4D;
        background: rgba(73, 144, 255, 0.1);
        border-radius: 16px;
        padding: 8px;
    }

    .section-icon svg,
    .section-icon img {
        width: 20px;
        height: 20px;
        object-fit: contain;
    }

    .section-icon-safety {
        background: #FEF0DC;
    }

    .section-icon-diagnoses {
        background: #DCFCE7;
    }

    .section-icon-allergies {
        background: #FFE2E2;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333333;
        margin: 0;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .optional-text {
        font-size: 0.85rem;
        font-weight: 400;
        color: #101828;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #4D4D4D;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .form-input {
        padding: 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        transition: all 0.3s ease;
        background: #ffffff;
    }

    .form-input:focus {
        outline: none;
        border-color: #4994FF;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }


    .age-input-container {
        display: flex;
        gap: 0.5rem;
        width: 100%;
    }

    .age-input-part {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 0;
    }

    .age-input {
        padding: 0.75rem 0.5rem;
        text-align: center;
        width: 100%;
    }

    .age-label {
        font-size: 0.7rem;
        color: #999;
        text-align: center;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%234D4D4D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px 8px;
        padding-right: 2.5rem;
        cursor: pointer;
    }

    .form-date {
        position: relative;
        cursor: pointer;
    }

    .form-date::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 1;
    }

    .search-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .search-container-with-icon {
        position: relative;
        gap: 0;
    }

    .search-icon-wrapper {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        pointer-events: none;
        z-index: 1;
    }

    .drug-search-results {
        margin-top: 0.5rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #ffffff;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .drug-result-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .drug-result-item:last-child {
        border-bottom: none;
    }

    .drug-result-item:hover {
        background: #f8f9fa;
    }

    .drug-result-name {
        font-weight: 500;
        color: #1A73E8;
        font-size: 0.95rem;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .drug-result-generic {
        font-size: 0.85rem;
        color: #666;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .search-container-inline {
        position: relative;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem 3rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #4994FF;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .add-button-inline {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: #4994FF;
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .selected-drugs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .drug-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: rgba(239, 246, 255, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(219, 234, 254, 1);
        margin-bottom: 0.5rem;
    }

    .drug-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
    }

    .drug-name {
        font-weight: 500;
        font-size: 16px;
        line-height: 24px;
        color: rgba(16, 24, 40, 1);
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .drug-generic {
        font-size: 14px;
        color: rgba(74, 85, 101, 1);
        font-weight: 400;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .drug-actions {
        display: flex;
        gap: 0.5rem;
    }

    .list-button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        color: #999;
        transition: color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .list-button svg,
    .list-button .calculator-icon {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .calculator-icon {
        width: 18px;
        height: 18px;
        object-fit: contain;
    }

    .remove-button {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0.25rem 0.5rem;
        color: #999;
        transition: color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-button svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .remove-button:hover {
        color: #e53935;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        color: #4D4D4D;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .custom-checkbox {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .custom-checkbox-input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        width: 20px;
        height: 20px;
        z-index: 1;
    }

    .custom-checkbox-mark {
        width: 20px;
        height: 20px;
        border: 2px solid #D0D5DD;
        border-radius: 4px;
        background: #ffffff;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .custom-checkbox-mark.checked {
        background: #4994FF;
        border-color: #4994FF;
    }

    .custom-checkbox-mark.checked::after {
        content: '';
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .custom-checkbox-input:focus + .custom-checkbox-mark {
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .checkbox-text {
        flex: 1;
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #e3f2fd;
        color: #1A73E8;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .tag-condition {
        background: #F3F4F6;
        border: 1px solid #E5E7EB;
        border-radius: 10px;
        color: #333333;
    }

    .tag-allergy {
        background: #FEF2F2;
        border: 1px solid #FFC9C9;
        border-radius: 10px;
        color: #82181A;
    }

    .tag-remove {
        background: transparent;
        border: none;
        cursor: pointer;
        color: black;
        font-size: 1rem;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .tag-remove svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        color: #82181A;
    }

    .tag-remove:hover {
        background: #1A73E8;
        color: white;
    }

    .form-actions {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        padding: 2rem 0;
    }

    .btn-check-safety {
        padding: 1rem 3rem;
        background: #4994FF;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-check-safety svg,
    .btn-check-safety .btn-check-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    .btn-check-icon {
        width: 20px;
        height: 20px;
        object-fit: contain;
    }

    .btn-check-safety:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
    }

    .btn-clear {
        background: transparent;
        color: #666;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        text-decoration: underline;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        transition: color 0.3s ease;
    }

    .btn-clear:hover {
        color: #1A73E8;
    }

    .summary-panel {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.08);
        height: fit-content;
    }

    .summary-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333333;
        margin: 0 0 1rem 0;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .summary-items {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .summary-item-vertical {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .summary-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
    }

    .summary-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        flex-shrink: 0;
        color: #4D4D4D;
        background: rgba(77, 77, 77, 0.1);
        border-radius: 16px;
        padding: 6px;
    }

    .summary-icon svg,
    .summary-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .summary-separator {
        height: 1px;
        background: #E5E7EB;
        margin: 0.5rem 0;
    }

    .summary-label {
        flex: 1;
        font-size: 0.9rem;
        color: #4D4D4D;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .summary-count {
        font-size: 1rem;
        font-weight: 700;
        color: #333333;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .summary-status {
        font-size: 0.9rem;
        font-weight: 600;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .summary-status.on {
        color: #FFB050;
    }

    .summary-status.off {
        color: #999;
    }

    .ads-container {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.08);
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        position: relative;
        overflow: hidden;
    }

    .ads-carousel-wrapper {
        width: 100%;
        height: 300px;
        overflow: hidden;
        position: relative;
    }

    .ads-carousel {
        display: flex;
        flex-direction: column;
        transition: transform 0.5s ease-in-out;
        height: 100%;
    }

    .ad-item {
        flex: 0 0 100%;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
    }

    .ad-item img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        border-radius: 8px;
        object-fit: contain;
    }

    .ads-indicators {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
        margin-top: 0.5rem;
    }

    .ads-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .ads-indicator:hover {
        background: rgba(0, 0, 0, 0.4);
    }

    .ads-indicator.active {
        background: #4994FF;
        width: 10px;
        height: 10px;
    }

    @@media (max-width: 1024px) {
        .form-container {
            grid-template-columns: 1fr;
        }

        .right-panel-wrapper {
            position: relative;
            top: 0;
        }
    }

    @@media (max-width: 768px) {
        .drug-interaction-form-page {
            padding: 1rem 0.75rem;
            min-height: auto;
        }

        .plan-banner {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .plan-banner-content {
            gap: 0.75rem;
        }

        .plan-label,
        .tokens-label {
            font-size: 0.75rem;
        }

        .plan-name,
        .tokens-count {
            font-size: 1rem;
        }

        .form-container {
            gap: 1rem;
        }

        .form-section {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
        }

        .section-header {
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            padding: 6px;
        }

        .section-icon svg,
        .section-icon img {
            width: 16px;
            height: 16px;
        }

        .section-title {
            font-size: 1rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .form-group {
            gap: 0.375rem;
        }

        .form-group label {
            font-size: 0.8rem;
        }

        .form-input {
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
        }

        .age-input {
            padding: 0.625rem 0.375rem;
        }

        .age-label {
            font-size: 0.65rem;
        }

        .search-container {
            margin-bottom: 0.75rem;
        }

        .search-input {
            padding: 0.625rem 2.5rem 0.625rem 0.75rem;
            font-size: 0.875rem;
        }

        .search-icon-wrapper {
            left: 0.75rem;
        }

        .drug-search-results {
            max-height: 150px;
        }

        .drug-result-item {
            padding: 0.625rem 0.75rem;
        }

        .drug-result-name {
            font-size: 0.875rem;
        }

        .drug-result-generic {
            font-size: 0.75rem;
        }

        .drug-item {
            padding: 0.625rem 0.75rem;
            margin-bottom: 0.375rem;
        }

        .drug-name {
            font-size: 14px;
            line-height: 20px;
        }

        .drug-generic {
            font-size: 12px;
        }

        .checkbox-group {
            gap: 0.75rem;
        }

        .checkbox-label {
            font-size: 0.875rem;
            gap: 0.5rem;
        }

        .custom-checkbox-mark {
            width: 18px;
            height: 18px;
        }

        .tags-container {
            gap: 0.375rem;
            margin-top: 0.75rem;
        }

        .tag {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            gap: 0.375rem;
        }

        .tag-remove {
            width: 16px;
            height: 16px;
        }

        .tag-remove svg {
            width: 12px;
            height: 12px;
        }

        .form-actions {
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem 0;
        }

        .btn-check-safety {
            width: 100%;
            padding: 0.875rem 1.5rem;
            font-size: 0.9rem;
            justify-content: center;
        }

        .btn-clear {
            font-size: 0.875rem;
        }

        .summary-panel {
            padding: 1rem;
        }

        .summary-title {
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }

        .summary-items {
            gap: 0.75rem;
        }

        .summary-item {
            gap: 0.5rem;
        }

        .summary-icon {
            width: 28px;
            height: 28px;
            padding: 5px;
        }

        .summary-icon svg,
        .summary-icon img {
            width: 16px;
            height: 16px;
        }

        .summary-label {
            font-size: 0.8rem;
        }

        .summary-count {
            font-size: 0.9rem;
        }

        .summary-status {
            font-size: 0.8rem;
        }

        .ads-container {
            padding: 0.75rem;
            min-height: 150px;
        }
    }
</style>
