@using SmartRx_DrugChecker.Services
@using Microsoft.AspNetCore.Components.Routing
@implements IDisposable
@inject UserService UserService

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<nav class="navbar-container @(isScrolled ? "scrolled" : "")">
    <div class="navbar-content">
        <div class="navbar-logo">
            <a href="/dashboard/drug-checker">
                <img src="images/logo.png" alt="SmartRX" class="logo-image" />
            </a>
        </div>

        <div class="navbar-right-section">
            <div class="market-selection">
                <button class="btn-market-egypt @(GetSelectedMarket() == "egypt" ? "active" : "")" @onclick='() => SelectMarket("egypt")'>
                    <img src="images/EgyptFlag.png" alt="Egypt" class="flag-icon" />
                    <span>Egypt Market</span>
                </button>
                <button class="link-market-saudi @(GetSelectedMarket() == "saudi" ? "active" : "")" @onclick='() => SelectMarket("saudi")'>
                    <img src="images/KSA.webp" alt="Saudi Arabia" class="flag-icon" />
                    <span>Saudi Market</span>
                </button>
            </div>
            <div class="navbar-user-profile">
                <div class="user-profile-dropdown" @onclick="ToggleUserMenu">
                    <div class="user-profile-avatar">
                        <img src="images/Doctor.png" alt="User Avatar" />
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow @(isUserMenuOpen ? "open" : "")">
                        <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                @if (isUserMenuOpen)
                {
                    <div class="user-menu-dropdown" @onclick:stopPropagation="true">
                        <!-- Profile Section -->
                        <div class="user-menu-profile-section">
                            <div class="user-menu-avatar">
                                <img src="images/Doctor.png" alt="User Avatar" />
                            </div>
                            <div class="user-menu-profile-info">
                                <div class="user-menu-name">Dr / @UserService.UserName</div>
                                <div class="user-menu-email">@UserService.UserEmail</div>
                            </div>
                        </div>

                        <!-- Credit Usage Section -->
                        <div class="user-menu-credit-section">
                            <div class="credit-usage-header">
                                <img src="images/Coins.svg" alt="Credit" class="credit-icon" />
                                <span class="credit-usage-label">Credit usage</span>
                            </div>
                            <div class="credit-progress-bar">
                                <div class="credit-progress-fill" style="width: @(UserService.GetCreditUsagePercentage())%"></div>
                            </div>
                            <div class="credit-usage-info">
                                <span class="credit-spent">Spent @FormatCredit(UserService.CreditSpent)</span>
                                <span class="credit-limit">Limit @FormatCredit(UserService.CreditLimit)</span>
                            </div>
                            <button class="upgrade-btn" @onclick="NavigateToPricing">
                                Upgrade
                            </button>
                        </div>

                        <!-- Subscribe Section -->
                        <button class="user-menu-subscribe-item" @onclick="NavigateToPricing">
                            <img src="images/Pot.svg" alt="Subscribe" class="subscribe-icon" />
                            <span>Subscribe</span>
                            <span class="plan-tag">@UserService.CurrentPlan</span>
                        </button>

                        <!-- Control Panel -->
                        <a href="@UserService.GetControlPanelRoute()" class="user-menu-item" @onclick="CloseUserMenu">
                            <img src="images/ControlPanel.svg" alt="Control Panel" class="menu-item-icon" />
                            <span>Control panel</span>
                        </a>

                        <!-- View Profile -->
                        <a href="/dashboard/settings" class="user-menu-item" @onclick="CloseUserMenu">
                            <img src="images/Profile.svg" alt="View Profile" class="menu-item-icon" />
                            <span>View Profile</span>
                        </a>

                        <!-- Separator -->
                        <div class="user-menu-separator"></div>

                        <!-- Help Center -->
                        <a href="/dashboard/help" class="user-menu-item" @onclick="CloseUserMenu">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-item-icon-svg">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9.09 9C9.3251 8.33167 9.78915 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.29152 14.92 10C14.92 12 11.92 13 11.92 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Help Center</span>
                        </a>

                        <!-- Separator -->
                        <div class="user-menu-separator"></div>

                        <!-- Log Out -->
                        <button class="user-menu-item logout-item" @onclick="HandleLogout">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="menu-item-icon-svg">
                                <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Log Out</span>
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</nav>
@if (isUserMenuOpen)
{
    <div class="user-menu-backdrop" @onclick="CloseUserMenu" @onclick:stopPropagation="false"></div>
}

<style>
    .navbar-container {
        position: fixed;
        top: 0;
        left: 80px;
        right: 0;
        width: calc(100% - 80px);
        z-index: 100;
        background: transparent;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        height: 150px;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid;
        border-image-source: linear-gradient(294.66deg, #4994FF 11.59%, rgba(234, 246, 255, 0.9) 61.74%, #3EE0B2 118.03%);
        border-image-slice: 1;
        transition: left 0.3s ease, width 0.3s ease, background 0.3s ease, backdrop-filter 0.3s ease;
    }

    .navbar-container.scrolled {
        background: #FFFFFF;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        max-width: 1440px;
        margin: 0 auto;
        box-sizing: border-box;
        height: 100%;
        padding: 0 clamp(1.5rem, 10.14vw, 146px);
    }

    @@media (min-width: 1440px) {
        .navbar-content {
            padding: 0;
        }
    }

    .navbar-logo {
        flex-shrink: 0;
    }

    .logo-image {
        width: 183px;
        height: 50px;
        object-fit: contain;
    }

    .navbar-right-section {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 4rem;
    }

    .market-selection {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-market-egypt {
        background: transparent;
        color: #4994FF;
        border: none;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-market-egypt:hover {
        color: #1565C0;
    }

    .btn-market-egypt.active {
        background: #4994FF;
        color: white;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .btn-market-egypt.active:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }

    .link-market-saudi {
        color: #4994FF;
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        gap: 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
    }

    .link-market-saudi:hover {
        color: #1565C0;
    }

    .link-market-saudi.active {
        background: #4994FF;
        color: white;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .link-market-saudi.active:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }

    .flag-icon {
        width: 20px;
        height: 15px;
        display: inline-block;
        object-fit: cover;
        border-radius: 2px;
        flex-shrink: 0;
    }

    .navbar-user-profile {
        position: relative;
        border-radius: 50px;
        padding: 1px;
        background: linear-gradient(294.66deg, rgba(73, 148, 255, 1) 11.59%, rgba(234, 246, 255, 0.9) 61.74%, rgba(62, 224, 178, 1) 118.03%);
        z-index: 1003;
    }

    .user-profile-dropdown {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .user-profile-dropdown:hover {
        background: rgba(73, 144, 255, 0.1);
    }

    .user-profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        overflow: visible;
        background: linear-gradient(270deg, #FFFFFF 19.36%, #4994FF 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: var(--sds-size-depth-0) var(--sds-size-depth-025) var(--sds-size-depth-100) var(--sds-size-depth-0) var(--sds-color-black-100);
        position: relative;
    }

    .user-profile-avatar img {
        width: calc(100% - 4px);
        height: calc(100% - 4px);
        object-fit: cover;
        border-radius: 10px;
        position: relative;
        z-index: 2;
    }

    .dropdown-arrow {
        transition: transform 0.3s ease;
        color: #6b7280;
        flex-shrink: 0;
    }

    .dropdown-arrow.open {
        transform: rotate(180deg);
    }

    .user-menu-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 320px;
        padding: 0;
        z-index: 1004;
        border: 1px solid #e5e7eb;
        pointer-events: auto;
        overflow: hidden;
    }

    .user-menu-profile-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .user-menu-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(270deg, #FFFFFF 19.36%, #4994FF 100%);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .user-menu-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .user-menu-profile-info {
        flex: 1;
        min-width: 0;
    }

    .user-menu-name {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-menu-email {
        font-size: 14px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-menu-credit-section {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .credit-usage-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .credit-icon {
        width: 20px;
        height: 20px;
        object-fit: contain;
    }

    .credit-usage-label {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
    }

    .credit-progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .credit-progress-fill {
        height: 100%;
        background: #4994FF;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .credit-usage-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 12px;
        color: #6b7280;
    }

    .credit-spent {
        font-weight: 500;
    }

    .credit-limit {
        font-weight: 500;
    }

    .upgrade-btn {
        width: 100%;
        padding: 0.75rem 1rem;
        background: #4994FF;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .upgrade-btn:hover {
        background: #357abd;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(73, 148, 255, 0.3);
    }

    .user-menu-subscribe-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: #111827;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
        width: 100%;
        border: none;
        background: transparent;
        cursor: pointer;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        pointer-events: auto;
        position: relative;
        z-index: 1003;
    }

    .user-menu-subscribe-item:hover {
        background: #f9fafb;
    }

    .subscribe-icon {
        width: 18px;
        height: 18px;
        object-fit: contain;
        flex-shrink: 0;
    }

    .plan-tag {
        margin-left: auto;
        padding: 0.25rem 0.75rem;
        background: #E0F2FE;
        color: #4994FF;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: #111827;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
        width: 100%;
        border: none;
        background: transparent;
        cursor: pointer;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        pointer-events: auto;
        position: relative;
        z-index: 1003;
    }

    .user-menu-item:hover {
        background: #f9fafb;
    }

    .user-menu-item.logout-item {
        color: #FF383C;
    }

    .user-menu-item.logout-item:hover {
        background: #FEF2F2;
    }

    .menu-item-icon {
        width: 18px;
        height: 18px;
        object-fit: contain;
        flex-shrink: 0;
    }

    .menu-item-icon-svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        color: #6b7280;
    }

    .user-menu-item.logout-item .menu-item-icon-svg {
        color: #FF383C;
    }

    .user-menu-separator {
        height: 1px;
        background: #e5e7eb;
        margin: 0;
    }

    .user-menu-backdrop {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1001;
        background: transparent;
        pointer-events: auto;
    }

    @@media (max-width: 1200px) {
        .navbar-container {
            left: 0;
            width: 100%;
            height: auto;
            min-height: 120px;
        }

        .navbar-content {
            padding: 20px 60px;
        }

        .logo-image {
            width: 146px;
            height: 40px;
        }

        .btn-market-egypt,
        .link-market-saudi {
            padding: 0.6rem 1.5rem;
            font-size: 14px;
        }

        .navbar-right-section {
            gap: 2.5rem;
        }
    }

    @@media (min-width: 1280px) and (max-width: 1366px) {
        .navbar-content {
            padding: 18px 50px;
        }

        .logo-image {
            width: 160px;
            height: 44px;
        }

        .user-profile-info {
            gap: 0.75rem;
        }

        .user-name {
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
        }

        .navbar-right-section {
            gap: 2.75rem;
        }

        .btn-market-egypt,
        .link-market-saudi {
            padding: 0.65rem 1.75rem;
            font-size: 15px;
        }
    }

    @@media (max-width: 992px) {
        .navbar-container {
            left: 0;
            width: 100%;
            height: auto;
            min-height: 100px;
        }

        .navbar-content {
            padding: 16px 40px;
        }

        .logo-image {
            width: 120px;
            height: 33px;
        }

        .user-profile-info {
            display: none;
        }

        .navbar-right-section {
            gap: 1.5rem;
        }
    }

    @@media (max-width: 768px) {
        .navbar-container {
            left: 0;
            width: 100%;
            height: auto;
            min-height: 80px;
        }

        .navbar-content {
            padding: 12px 24px;
        }

        .logo-image {
            width: 110px;
            height: 30px;
        }

        .market-selection {
            display: none;
        }

        .navbar-right-section {
            gap: 1rem;
        }
    }
</style>

@code {
    [Inject]
    private NavigationManager? Navigation { get; set; }

    [Inject]
    private MarketStateService? MarketState { get; set; }

    [Inject]
    private ModalStateService? ModalState { get; set; }

    private bool isUserMenuOpen = false;
    private bool isScrolled = false;

    [Inject]
    private IJSRuntime? JSRuntime { get; set; }

    protected override void OnInitialized()
    {
        if (ModalState != null)
        {
            ModalState.OnModalStateChanged += HandleModalStateChanged;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && JSRuntime != null)
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    let scrollHandler = function() {
                        const navbar = document.querySelector('.navbar-container');
                        if (navbar) {
                            const scrolled = window.scrollY > 10;
                            navbar.classList.toggle('scrolled', scrolled);
                        }
                    };
                    window.addEventListener('scroll', scrollHandler);
                    // Check initial scroll position
                    scrollHandler();
                })();
            ");
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && isUserMenuOpen)
        {
            // Close menu when clicking outside
            // This will be handled by the click event on the document
        }
    }

    public void Dispose()
    {
        if (ModalState != null)
        {
            ModalState.OnModalStateChanged -= HandleModalStateChanged;
        }
    }

    private void HandleModalStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
        StateHasChanged();
    }

    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
        StateHasChanged();
    }

    private void SelectMarket(string market)
    {
        if (MarketState != null)
        {
            MarketState.SelectedMarket = market;
        }
        StateHasChanged();
    }

    private string GetSelectedMarket()
    {
        return MarketState?.SelectedMarket ?? "egypt";
    }


    private string FormatCredit(decimal credit)
    {
        if (credit >= 1000)
        {
            return $"{credit / 1000:F1}K";
        }
        return credit.ToString("F0");
    }

    private void NavigateToPricing()
    {
        CloseUserMenu();
        if (Navigation != null)
        {
            Navigation.NavigateTo("/dashboard/pricing");
        }
    }

    private async Task HandleLogout()
    {
        CloseUserMenu();
        
        // Clear token from localStorage
        if (JSRuntime != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "token");
            }
            catch
            {
                // Ignore errors if localStorage is not available
            }
        }
        
        // Navigate to main page
        if (Navigation != null)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
    }
}
